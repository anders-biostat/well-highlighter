<!DOCTYPE html>
<html>
<head>

<meta charset="utf-8">
<title>Well Highlighter</title>
<script type="text/javascript" src="d3.v5.min.js"></script>

<style>

	body {
		background: black;
		color: white;
		font-family: sans-serif;
		padding-left: 100px;
	}

	svg#plate {
		padding-bottom: 100px;
		padding-right: 140px;
	}

	circle {
		fill: gray;
	}

	circle.current {
		fill: white;
	}
	circle.next {
		fill: gray;
	}

	circle.empty {
		stroke: blue;
	}
	circle.filled {
		stroke: orange;
	}

	.row_label, .col_label {
		fill: yellow;
	}

	div#well_list {
		min-width: 200px;
		border-style: dotted;
	}

	div#well_list table {
		margin: 15px;		
	}

	input#next_barcode {
		font-size: 30px; 
		width: 250px;
		background-color: #202020;
		color: white;
		border-color: gray;
		padding: 5px;
	}

	button {
		background-color: darkblue;
		color: white;
		padding-top: 10px;
		padding-bottom: 10px;
		padding-left: 20px;
		padding-right: 20px;
		margin-top: 30px;
	}


</style>

</head>
<body>

<h2 style="padding-bottom: 50px">Well Highlighter</h2>

<table><tr>
	<td>
		<svg id="plate" ></svg>
	</td>
	<td>
		<div id="well_list" style="overflow-y:scroll">
			<table id="well_list"></table>
		</div>
	</td>
</tr>
</table>

<table><tr><td>
<table id="bottom_table">
	<tr style="text-align:center">
		<td></td>
		<td>Barcode:</td>
		<td></td>
		<td>Well:</td>
	</tr>
	<tr>
		<td>current sample:&nbsp;&nbsp;&nbsp;</td>
		<td style="text-align:center;font-size:30px" id="current_barcode"></td>
		<td style="text-align:center;font-size:50px">&nbsp;&rarr;&nbsp;</td>
		<td><span id="current_well" style="font-size: 50px"></span></td>
	</tr>
	<tr style="color:#A0A0A0">
		<td>next sample:</td>
		<td><input type="text" id="next_barcode" onchange="barcode_entered()"></td>
		<td style="text-align:center;font-size:50px">&nbsp;&rarr;&nbsp;</td>
		<td><span id="next_well" style="font-size: 50px"></span></td>
	</tr>
	</table>
</td><td style="padding-left: 150px">
	<button id="save_button" onclick="save_plate()">Save plate table</button><br>
	<button id="about_button" onclick="about()" style="font-size: 70%">About Well Highlighter</button>
</table></td></tr></table>

<div id="test"></div>

<script type="text/javascript">

	var plate_scaling_factor = 40

	var wells = 
		d3.range(96).map( function(i) {
			return {
				row_num: Math.floor( i / 12 ) + 1,
				row: String.fromCharCode( 65 + Math.floor( i / 12 ) ),
				col: i % 12 + 1,
				content: ""
			} } )

	var current_well = -1;
	var next_well = 0;

	update = function() {
		plateSVG
			.selectAll( "circle" )
				.classed( "empty", d => d["content"] == ""  )
				.classed( "filled", d => d["content"] != ""  )
				.classed( "current", ( d, i ) => i == current_well )
				.classed( "next", ( d, i ) => i == next_well )

		table_rows
			.selectAll( "tr td.well_content" )
				.text( d => d["content"] )
		scroll_to = current_well>-1 ? current_well : next_well
		if( next_well > -1 ) {
		   table_rows.select( `tr[well_idx="${scroll_to}"] td` ).node().scrollIntoView(
			   alignToTop=false, scrollIntoViewOptions = {behavior: "smooth", block:"nearest"} )
		}

		d3.select( "#current_well" )
			.text( current_well>-1 ? wells[current_well]["row"] + wells[current_well]["col"] : "––" )
		d3.select( "#next_well" )
			.text( next_well>-1 ? wells[next_well]["row"] + wells[next_well]["col"] : "––" )

		d3.select( "#current_barcode" )
			.text( current_well>-1 ? wells[current_well]["content"] : "" )
		d3.select( "input#next_barcode" )
			.property( "value", next_well>-1 ? wells[next_well]["content"] : "" )
	}

	select_well = function( i ) {
		current_well = -1
		next_well = i
		update()
		d3.select("input#next_barcode").node().focus()
	}

	barcode_entered = function() {
		if( next_well == -1 ) {
			alert( "End of plate." )
			return
		}
		wells[next_well]["content"] = d3.select( "input#next_barcode" ).property("value")
		current_well = next_well
		next_well += 1
		if( next_well == wells.length )
			next_well = -1
		update();
	}

	var plateSVG = d3.select( "svg#plate" )
			
	plateSVG
		.attr( "width", plate_scaling_factor * (12+3) )
		.attr( "height", plate_scaling_factor * (8+3) )
	
	plateSVG
		.selectAll( "circle" )
		.data( wells ).enter().append( "circle" )
			.attr( "cx", d => ( 2 + d["col"] ) * plate_scaling_factor )
			.attr( "cy", d => ( 2 + d["row_num"] ) * plate_scaling_factor )
			.attr( "r", .2 * plate_scaling_factor )
			.on( "click", function( d, i ) { select_well( i ) } )

	plateSVG
		.selectAll( "text.row_label" )
		.data( d3.range(8) ).enter().append( "text" )
			.attr( "x", d => 0 )
			.attr( "y", d => (d+3) * plate_scaling_factor )
			.attr( "dominant-baseline", "middle" )
			.text( d => String.fromCharCode( 65 + d ) )
			.classed( "row_label", true )

	plateSVG
		.selectAll( "text.col_label" )
		.data( d3.range(12) ).enter().append( "text" )
			.attr( "x", d => (d+3) * plate_scaling_factor )
			.attr( "y", d => 0.3 * plate_scaling_factor )
			.attr( "text-anchor", "middle" )
			.text( d => d+1 )
			.classed( "col_label", true )

	d3.select( "div#well_list")
		.style( "height", 8 * plate_scaling_factor + "px" )

	var table_rows = 
	d3.select( "table#well_list")
		.selectAll( "tr" )
		.data( wells ).enter().append( "tr" )
			.attr( "well_idx", ( d, i ) => i );

	table_rows
		.append( "td" )
			.classed( "well_pos", true )
			.text( d => d["row"] + d["col"] )
	table_rows
		.append( "td" )
			.classed( "well_content", true )


	update()
	d3.select("input#next_barcode").node().focus()

	save_plate = function() {

		lines = wells.map( d => d["row"] + d["col"] + "," + d["content"] ).join( "\n" ) + "\n"

		filename = prompt( "Enter filename (or scan plate barcode)" )

		if( filename == "" )
			return

		// Code taken from https://ourcodeworld.com/articles/read/189/how-to-create-a-file-and-generate-a-download-with-javascript-in-the-browser-without-a-serve
		var element = document.createElement('a');
  		element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent( lines ) );
  		element.setAttribute('download', filename + ".csv" );
		element.style.display = 'none';
  		document.body.appendChild(element);
		element.click();
		document.body.removeChild(element);		
	}

	about = function() {
		alert( "Well Highlighter\n\nwritten by S. Anders (sanders@fs.tum.de)\nZMBH, Univ Heidelberg, April 2020")
	}

</script>
</body>
</html>
